generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String   @id @default(cuid())
  name           String   @unique
  pin            String
  avatarUrl      String?
  favoriteTeamId String?
  isAdmin        Boolean  @default(false)
  createdAt      DateTime @default(now())

  predictions       Prediction[]
  scores            Score[]
  seasonPredictions SeasonPrediction[]
}

model Season {
  id       Int     @id @default(autoincrement())
  year     Int     @unique
  isActive Boolean @default(false)

  races             Race[]
  seasonPredictions SeasonPrediction[]
}

model Race {
  id           Int       @id @default(autoincrement())
  seasonId     Int
  season       Season    @relation(fields: [seasonId], references: [id])
  name         String
  country      String
  countryEmoji String
  circuit      String
  round        Int
  hasSprint    Boolean   @default(false)
  qualiStart   DateTime
  sprintStart  DateTime?
  raceStart    DateTime
  isCompleted  Boolean   @default(false)

  predictions Prediction[]
  results     RaceResult[]
  scores      Score[]

  @@unique([seasonId, round])
}

model Prediction {
  id          Int      @id @default(autoincrement())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  raceId      Int
  race        Race     @relation(fields: [raceId], references: [id])
  sessionType String
  p1DriverId  String
  p2DriverId  String?
  p3DriverId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isLocked    Boolean  @default(false)

  @@unique([userId, raceId, sessionType])
}

model RaceResult {
  id          Int    @id @default(autoincrement())
  raceId      Int
  race        Race   @relation(fields: [raceId], references: [id])
  sessionType String
  p1DriverId  String
  p2DriverId  String?
  p3DriverId  String?

  @@unique([raceId, sessionType])
}

model Score {
  id          Int    @id @default(autoincrement())
  userId      String
  user        User   @relation(fields: [userId], references: [id])
  raceId      Int
  race        Race   @relation(fields: [raceId], references: [id])
  sessionType String
  basePoints  Int
  bonusPoints Int    @default(0)
  totalPoints Int
  breakdown   String

  @@unique([userId, raceId, sessionType])
}

model SeasonPrediction {
  id               Int      @id @default(autoincrement())
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  seasonId         Int
  season           Season   @relation(fields: [seasonId], references: [id])
  championDriverId String
  championTeamId   String
  isLocked         Boolean  @default(false)
  createdAt        DateTime @default(now())

  @@unique([userId, seasonId])
}
